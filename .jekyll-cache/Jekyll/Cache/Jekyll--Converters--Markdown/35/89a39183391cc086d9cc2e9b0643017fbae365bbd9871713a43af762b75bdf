I"»Ø<h2 id="zygoteinitmain">ZygoteInit.main</h2>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œè™šæ‹Ÿæœºåˆ›å»ºåï¼Œæ‰§è¡Œçš„ç¬¬ä¸€ä¸ªjavaä»£ç æ˜¯ZygoteInitçš„mainæ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹è¿™ä¸ªæ–¹æ³•å†…éƒ¨çš„ä¸€äº›ä¸»è¦ä»£ç ï¼š</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="o">...</span>
<span class="n">zygoteServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ZygoteServer</span><span class="o">(</span><span class="n">isPrimaryZygote</span><span class="o">);</span>

<span class="k">if</span> <span class="o">(</span><span class="n">startSystemServer</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Runnable</span> <span class="n">r</span> <span class="o">=</span> <span class="n">forkSystemServer</span><span class="o">(</span><span class="n">abiList</span><span class="o">,</span> <span class="n">zygoteSocketName</span><span class="o">,</span> <span class="n">zygoteServer</span><span class="o">);</span>

    <span class="c1">// {@code r == null} in the parent (zygote) process, and {@code r != null} in the</span>
    <span class="c1">// child (system_server) process.</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">r</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="nc">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Accepting command socket connections"</span><span class="o">);</span>

<span class="c1">// The select loop returns early in the child process after a fork and</span>
<span class="c1">// loops forever in the zygote.</span>
<span class="n">caller</span> <span class="o">=</span> <span class="n">zygoteServer</span><span class="o">.</span><span class="na">runSelectLoop</span><span class="o">(</span><span class="n">abiList</span><span class="o">);</span>
<span class="o">...</span>
<span class="c1">// We're in the child process and have exited the select loop. Proceed to execute the</span>
<span class="c1">// command.</span>
<span class="k">if</span> <span class="o">(</span><span class="n">caller</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">caller</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>æˆ‘ä»¬çœ‹ä¸‹ZygoteServer.javaä¸­çš„runSelectLoopè¿™ä¸ªæ–¹æ³•ä¸­çš„ä¸»è¦ä»£ç </p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="cm">/**
 * Runs the zygote process's select loop. Accepts new connections as
 * they happen, and reads commands from connections one spawn-request's
 * worth at a time.
 */</span>
<span class="nc">Runnable</span> <span class="nf">runSelectLoop</span><span class="o">(</span><span class="nc">String</span> <span class="n">abiList</span><span class="o">)</span> <span class="o">{</span>
<span class="o">...</span>
  <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
  <span class="o">...</span>
    <span class="nc">ZygoteConnection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">peers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">pollIndex</span><span class="o">);</span>
    <span class="kd">final</span> <span class="nc">Runnable</span> <span class="n">command</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">processOneCommand</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
  <span class="o">...</span>
  <span class="o">}</span>
<span class="o">}</span>
<span class="o">...</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æˆ‘ä»¬æ¥ç€çœ‹ä¸‹ZygoteConnection.javaä¸­çš„processOneCommandè¿™ä¸ªæ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œä¼šç­‰å¾…åœ¨
args = Zygote.readArgumentList(mSocketReader);è¿™ä¸ªä»£ç å¤„ï¼Œå½“AMSè¯·æ±‚å¯åŠ¨ä¸€ä¸ªå­åº”ç”¨ç¨‹åºçš„æ—¶å€™ï¼Œ
ä¼šå¾€è¿™ä¸ªsocketä¸­å‘é€æ¶ˆæ¯ï¼Œè¿™ä¸ªæ—¶å€™ä¼šæ‹¿åˆ°æ¶ˆæ¯æ”¾å…¥argsä¸­ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
</pre></td><td class="rouge-code"><pre><span class="cm">/**
     * Reads one start command from the command socket. If successful, a child is forked and a
     * {@code Runnable} that calls the childs main method (or equivalent) is returned in the child
     * process. {@code null} is always returned in the parent process (the zygote).
     *
     * If the client closes the socket, an {@code EOF} condition is set, which callers can test
     * for by calling {@code ZygoteConnection.isClosedByPeer}.
     */</span>
    <span class="nc">Runnable</span> <span class="nf">processOneCommand</span><span class="o">(</span><span class="nc">ZygoteServer</span> <span class="n">zygoteServer</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">args</span><span class="o">[];</span>
        <span class="nc">ZygoteArguments</span> <span class="n">parsedArgs</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">FileDescriptor</span><span class="o">[]</span> <span class="n">descriptors</span><span class="o">;</span>
        <span class="o">...</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nc">Zygote</span><span class="o">.</span><span class="na">readArgumentList</span><span class="o">(</span><span class="n">mSocketReader</span><span class="o">);</span>
        <span class="o">...</span>
        <span class="n">parsedArgs</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ZygoteArguments</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
        <span class="o">...</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">mPreloadDefault</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">handlePreload</span><span class="o">();</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">mPreloadPackage</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">handlePreloadPackage</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">mPreloadPackage</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mPreloadPackageLibs</span><span class="o">,</span>
                    <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mPreloadPackageLibFileName</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mPreloadPackageCacheKey</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">canPreloadApp</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mPreloadApp</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">rawParcelData</span> <span class="o">=</span> <span class="nc">Base64</span><span class="o">.</span><span class="na">getDecoder</span><span class="o">().</span><span class="na">decode</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">mPreloadApp</span><span class="o">);</span>
            <span class="nc">Parcel</span> <span class="n">appInfoParcel</span> <span class="o">=</span> <span class="nc">Parcel</span><span class="o">.</span><span class="na">obtain</span><span class="o">();</span>
            <span class="n">appInfoParcel</span><span class="o">.</span><span class="na">unmarshall</span><span class="o">(</span><span class="n">rawParcelData</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">rawParcelData</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
            <span class="n">appInfoParcel</span><span class="o">.</span><span class="na">setDataPosition</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
            <span class="nc">ApplicationInfo</span> <span class="n">appInfo</span> <span class="o">=</span> <span class="nc">ApplicationInfo</span><span class="o">.</span><span class="na">CREATOR</span><span class="o">.</span><span class="na">createFromParcel</span><span class="o">(</span><span class="n">appInfoParcel</span><span class="o">);</span>
            <span class="n">appInfoParcel</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">appInfo</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">handlePreloadApp</span><span class="o">(</span><span class="n">appInfo</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Failed to deserialize --preload-app"</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="o">...</span>

        <span class="cm">/**
         * In order to avoid leaking descriptors to the Zygote child,
         * the native code must close the two Zygote socket descriptors
         * in the child process before it switches from Zygote-root to
         * the UID and privileges of the application being launched.
         *
         * In order to avoid "bad file descriptor" errors when the
         * two LocalSocket objects are closed, the Posix file
         * descriptors are released via a dup2() call which closes
         * the socket and substitutes an open descriptor to /dev/null.
         */</span>

        <span class="kt">int</span> <span class="o">[]</span> <span class="n">fdsToClose</span> <span class="o">=</span> <span class="o">{</span> <span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">};</span>

        <span class="nc">FileDescriptor</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">mSocket</span><span class="o">.</span><span class="na">getFileDescriptor</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">fd</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">fdsToClose</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="na">getInt</span><span class="err">$</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="n">fd</span> <span class="o">=</span> <span class="n">zygoteServer</span><span class="o">.</span><span class="na">getZygoteSocketFileDescriptor</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">fd</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">fdsToClose</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="na">getInt</span><span class="err">$</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="n">fd</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="n">pid</span> <span class="o">=</span> <span class="nc">Zygote</span><span class="o">.</span><span class="na">forkAndSpecialize</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">mUid</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mGid</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mGids</span><span class="o">,</span>
                <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mRuntimeFlags</span><span class="o">,</span> <span class="n">rlimits</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mMountExternal</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mSeInfo</span><span class="o">,</span>
                <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mNiceName</span><span class="o">,</span> <span class="n">fdsToClose</span><span class="o">,</span> <span class="n">fdsToIgnore</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mStartChildZygote</span><span class="o">,</span>
                <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mInstructionSet</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mAppDataDir</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mTargetSdkVersion</span><span class="o">);</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// in child</span>
                <span class="n">zygoteServer</span><span class="o">.</span><span class="na">setForkChild</span><span class="o">();</span>

                <span class="n">zygoteServer</span><span class="o">.</span><span class="na">closeServerSocket</span><span class="o">();</span>
                <span class="nc">IoUtils</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">serverPipeFd</span><span class="o">);</span>
                <span class="n">serverPipeFd</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

                <span class="k">return</span> <span class="nf">handleChildProc</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">,</span> <span class="n">descriptors</span><span class="o">,</span> <span class="n">childPipeFd</span><span class="o">,</span>
                        <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mStartChildZygote</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="c1">// In the parent. A pid &lt; 0 indicates a failure and will be handled in</span>
                <span class="c1">// handleParentProc.</span>
                <span class="nc">IoUtils</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">childPipeFd</span><span class="o">);</span>
                <span class="n">childPipeFd</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="n">handleParentProc</span><span class="o">(</span><span class="n">pid</span><span class="o">,</span> <span class="n">descriptors</span><span class="o">,</span> <span class="n">serverPipeFd</span><span class="o">);</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="nc">IoUtils</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">childPipeFd</span><span class="o">);</span>
            <span class="nc">IoUtils</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">serverPipeFd</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>å‘ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°Zygote.forkAndSpecializeè¿™ä¸ªä¼šåœ¨åº•å±‚è°ƒç”¨forkæ¥äº§ç”Ÿä¸€ä¸ªå­è¿›ç¨‹ï¼Œæˆ‘ä»¬çŸ¥é“å­è¿›ç¨‹ä¸­è¿”å›çš„pidå€¼æ˜¯0ï¼Œçˆ¶è¿›ç¨‹ä¸­è¿”å›çš„pidæ˜¯å­è¿›ç¨‹çš„è¿›ç¨‹å·ã€‚
æ‰€ä»¥æˆ‘ä»¬çœ‹ä¸‹handleChildProcè¿™ä¸ªå‡½æ•°ï¼Œå­è¿›ç¨‹ä¼šæ‰§è¡Œè¿™ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬çœ‹çœ‹è¿™ä¸ªå‡½æ•°</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre></td><td class="rouge-code"><pre><span class="cm">/**
 * Handles post-fork setup of child proc, closing sockets as appropriate,
 * reopen stdio as appropriate, and ultimately throwing MethodAndArgsCaller
 * if successful or returning if failed.
 *
 * @param parsedArgs non-null; zygote args
 * @param descriptors null-ok; new file descriptors for stdio if available.
 * @param pipeFd null-ok; pipe for communication back to Zygote.
 * @param isZygote whether this new child process is itself a new Zygote.
 */</span>
<span class="kd">private</span> <span class="nc">Runnable</span> <span class="nf">handleChildProc</span><span class="o">(</span><span class="nc">ZygoteArguments</span> <span class="n">parsedArgs</span><span class="o">,</span> <span class="nc">FileDescriptor</span><span class="o">[]</span> <span class="n">descriptors</span><span class="o">,</span>
        <span class="nc">FileDescriptor</span> <span class="n">pipeFd</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">isZygote</span><span class="o">)</span> <span class="o">{</span>
    <span class="cm">/**
     * By the time we get here, the native code has closed the two actual Zygote
     * socket connections, and substituted /dev/null in their place.  The LocalSocket
     * objects still need to be closed properly.
     */</span>

    <span class="n">closeSocket</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">descriptors</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Os</span><span class="o">.</span><span class="na">dup2</span><span class="o">(</span><span class="n">descriptors</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="no">STDIN_FILENO</span><span class="o">);</span>
            <span class="nc">Os</span><span class="o">.</span><span class="na">dup2</span><span class="o">(</span><span class="n">descriptors</span><span class="o">[</span><span class="mi">1</span><span class="o">],</span> <span class="no">STDOUT_FILENO</span><span class="o">);</span>
            <span class="nc">Os</span><span class="o">.</span><span class="na">dup2</span><span class="o">(</span><span class="n">descriptors</span><span class="o">[</span><span class="mi">2</span><span class="o">],</span> <span class="no">STDERR_FILENO</span><span class="o">);</span>

            <span class="k">for</span> <span class="o">(</span><span class="nc">FileDescriptor</span> <span class="nl">fd:</span> <span class="n">descriptors</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">IoUtils</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">fd</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ErrnoException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Error reopening stdio"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">mNiceName</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Process</span><span class="o">.</span><span class="na">setArgV0</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">mNiceName</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// End of the postFork event.</span>
    <span class="nc">Trace</span><span class="o">.</span><span class="na">traceEnd</span><span class="o">(</span><span class="nc">Trace</span><span class="o">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">mInvokeWith</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">WrapperInit</span><span class="o">.</span><span class="na">execApplication</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">mInvokeWith</span><span class="o">,</span>
                <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mNiceName</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mTargetSdkVersion</span><span class="o">,</span>
                <span class="nc">VMRuntime</span><span class="o">.</span><span class="na">getCurrentInstructionSet</span><span class="o">(),</span>
                <span class="n">pipeFd</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mRemainingArgs</span><span class="o">);</span>

        <span class="c1">// Should not get here.</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"WrapperInit.execApplication unexpectedly returned"</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">isZygote</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">ZygoteInit</span><span class="o">.</span><span class="na">zygoteInit</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">mTargetSdkVersion</span><span class="o">,</span>
                    <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mRemainingArgs</span><span class="o">,</span> <span class="kc">null</span> <span class="cm">/* classLoader */</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">ZygoteInit</span><span class="o">.</span><span class="na">childZygoteInit</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">mTargetSdkVersion</span><span class="o">,</span>
                    <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mRemainingArgs</span><span class="o">,</span> <span class="kc">null</span> <span class="cm">/* classLoader */</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æˆ‘ä»¬æ¥ç€çœ‹çœ‹ZygoteInit.javaä¸­childZygoteInitæ–¹æ³•ï¼Œå¦‚ä¸‹</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="cm">/**
 * The main function called when starting a child zygote process. This is used as an alternative
 * to zygoteInit(), which skips calling into initialization routines that start the Binder
 * threadpool.
 */</span>
<span class="kd">static</span> <span class="kd">final</span> <span class="nc">Runnable</span> <span class="nf">childZygoteInit</span><span class="o">(</span>
        <span class="kt">int</span> <span class="n">targetSdkVersion</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">argv</span><span class="o">,</span> <span class="nc">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">RuntimeInit</span><span class="o">.</span><span class="na">Arguments</span> <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RuntimeInit</span><span class="o">.</span><span class="na">Arguments</span><span class="o">(</span><span class="n">argv</span><span class="o">);</span>
    <span class="k">return</span> <span class="nc">RuntimeInit</span><span class="o">.</span><span class="na">findStaticMain</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">startClass</span><span class="o">,</span> <span class="n">args</span><span class="o">.</span><span class="na">startArgs</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>æˆ‘ä»¬æ¥ç€çœ‹ä¸‹RuntimeInit.javaä¸­çš„findStaticMainæ–¹æ³•</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
</pre></td><td class="rouge-code"><pre><span class="cm">/**
  * Invokes a static "main(argv[]) method on class "className".
  * Converts various failing exceptions into RuntimeExceptions, with
  * the assumption that they will then cause the VM instance to exit.
  *
  * @param className Fully-qualified class name
  * @param argv Argument vector for main()
  * @param classLoader the classLoader to load {@className} with
  */</span>
 <span class="kd">protected</span> <span class="kd">static</span> <span class="nc">Runnable</span> <span class="nf">findStaticMain</span><span class="o">(</span><span class="nc">String</span> <span class="n">className</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">argv</span><span class="o">,</span>
         <span class="nc">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span> <span class="o">{</span>
     <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">cl</span><span class="o">;</span>

     <span class="k">try</span> <span class="o">{</span>
         <span class="n">cl</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">className</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">);</span>
     <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ClassNotFoundException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span>
                 <span class="s">"Missing class when invoking static main "</span> <span class="o">+</span> <span class="n">className</span><span class="o">,</span>
                 <span class="n">ex</span><span class="o">);</span>
     <span class="o">}</span>

     <span class="nc">Method</span> <span class="n">m</span><span class="o">;</span>
     <span class="k">try</span> <span class="o">{</span>
         <span class="n">m</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"main"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Class</span><span class="o">[]</span> <span class="o">{</span> <span class="nc">String</span><span class="o">[].</span><span class="na">class</span> <span class="o">});</span>
     <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">NoSuchMethodException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span>
                 <span class="s">"Missing static main on "</span> <span class="o">+</span> <span class="n">className</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
     <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SecurityException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span>
                 <span class="s">"Problem getting static main on "</span> <span class="o">+</span> <span class="n">className</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
     <span class="o">}</span>

     <span class="kt">int</span> <span class="n">modifiers</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">();</span>
     <span class="k">if</span> <span class="o">(!</span> <span class="o">(</span><span class="nc">Modifier</span><span class="o">.</span><span class="na">isStatic</span><span class="o">(</span><span class="n">modifiers</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="nc">Modifier</span><span class="o">.</span><span class="na">isPublic</span><span class="o">(</span><span class="n">modifiers</span><span class="o">)))</span> <span class="o">{</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span>
                 <span class="s">"Main method is not public and static on "</span> <span class="o">+</span> <span class="n">className</span><span class="o">);</span>
     <span class="o">}</span>

     <span class="cm">/*
      * This throw gets caught in ZygoteInit.main(), which responds
      * by invoking the exception's run() method. This arrangement
      * clears up all the stack frames that were required in setting
      * up the process.
      */</span>
     <span class="k">return</span> <span class="k">new</span> <span class="nf">MethodAndArgsCaller</span><span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="n">argv</span><span class="o">);</span>
 <span class="o">}</span>
 <span class="o">...</span>
 <span class="cm">/**
     * Helper class which holds a method and arguments and can call them. This is used as part of
     * a trampoline to get rid of the initial process setup stack frames.
     */</span>
    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MethodAndArgsCaller</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="cm">/** method to call */</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Method</span> <span class="n">mMethod</span><span class="o">;</span>

        <span class="cm">/** argument array */</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">mArgs</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">MethodAndArgsCaller</span><span class="o">(</span><span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mMethod</span> <span class="o">=</span> <span class="n">method</span><span class="o">;</span>
            <span class="n">mArgs</span> <span class="o">=</span> <span class="n">args</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">mMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[]</span> <span class="o">{</span> <span class="n">mArgs</span> <span class="o">});</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IllegalAccessException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InvocationTargetException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Throwable</span> <span class="n">cause</span> <span class="o">=</span> <span class="n">ex</span><span class="o">.</span><span class="na">getCause</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">cause</span> <span class="k">instanceof</span> <span class="nc">RuntimeException</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="o">(</span><span class="nc">RuntimeException</span><span class="o">)</span> <span class="n">cause</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">cause</span> <span class="k">instanceof</span> <span class="nc">Error</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="o">(</span><span class="nc">Error</span><span class="o">)</span> <span class="n">cause</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
 
</pre></td></tr></tbody></table></code></pre></div></div>
<p>è¿™ä¸ªè¿”å›çš„MethodAndArgsCallerç±»å‹çš„å¯¹è±¡åœ¨è¿”å›åˆ°ZygoteInit.mainå‡½æ•°ä¸­ï¼Œå…¶runæ–¹æ³•ä¼šè¢«æ‰§è¡Œã€‚
é€šè¿‡åŠ æ‰“å°ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œè¿™ä¸ªå¯¹è±¡åŒ…è£¹çš„mMethodæ˜¯ActivityThreadå¯¹è±¡ä¸­çš„mainæ–¹æ³•ï¼Œä¼ å…¥çš„æ–¹æ³•å‚æ•°æ˜¯mArgsï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹
è¿™ä¸ªmainæ–¹æ³•è¢«åå°„è°ƒç”¨æ‰§è¡Œçš„è¿‡ç¨‹ã€‚</p>

<h2 id="activitymain">Activity.main</h2>
<p>æˆ‘ä»¬çœ‹ä¸‹è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘åœ¨æ–¹æ³•çš„å¼€å¤´æ·»åŠ äº†å¦‚ä¸‹æ‰“å°ï¼Œç„¶åæ‰§è¡Œäº†äº¬ä¸œè¿™ä¸ªåº”ç”¨ï¼Œæ•æ‰åˆ°äº†äº¬ä¸œè¿™ä¸ªåº”ç”¨åœ¨è¢«ç³»ç»Ÿå¯åŠ¨çš„è¿‡ç¨‹ä¸­çš„å„ä¸ªæ•°æ®ã€‚</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Trace</span><span class="o">.</span><span class="na">traceBegin</span><span class="o">(</span><span class="nc">Trace</span><span class="o">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="o">,</span> <span class="s">"ActivityThreadMain"</span><span class="o">);</span>

        <span class="nc">Slog</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">"zheng-hanhan.gitee.io -&gt; "</span><span class="o">,</span> <span class="s">"prepare to print args in ActivityThread.main"</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">Slog</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">"zheng-hanhan.gitee.io -&gt; "</span><span class="o">,</span> <span class="s">"args["</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">"] = "</span> <span class="o">+</span> <span class="n">args</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
        <span class="o">}</span>
        <span class="nc">Slog</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">"zheng-hanhan.gitee.io -&gt; "</span><span class="o">,</span> <span class="s">"end to print args in ActivityThread.main"</span><span class="o">);</span>
        <span class="o">...</span>
        <span class="nc">Looper</span><span class="o">.</span><span class="na">prepareMainLooper</span><span class="o">();</span>
        <span class="o">...</span>
        <span class="nc">ActivityThread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ActivityThread</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"zheng-hanhan.gitee.io -&gt; "</span> <span class="o">+</span> <span class="s">"startSeq : "</span> <span class="o">+</span> <span class="n">startSeq</span><span class="o">);</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">attach</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="n">startSeq</span><span class="o">);</span>
        <span class="o">...</span>
        <span class="nc">Looper</span><span class="o">.</span><span class="na">loop</span><span class="o">();</span>
        <span class="o">...</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åœ¨æ—¥å¿—ä¸­è¾“å‡ºå¦‚ä¸‹å‡ è¡Œï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>1022 09-09 18:35:54.967  3602  3602 E zheng-hanhan.gitee.io -&gt; : prepare to print args in ActivityThread.main
1023 09-09 18:35:54.967  3602  3602 E zheng-hanhan.gitee.io -&gt; : args[0] = seq=41
1024 09-09 18:35:54.967  3602  3602 E zheng-hanhan.gitee.io -&gt; : end to print args in ActivityThread.main
</pre></td></tr></tbody></table></code></pre></div></div>
<p>å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªargsæ•°ç»„å…¶å®å°±ä¸€ä¸ªå…ƒç´ ï¼Œè¯¥å…ƒç´ ä¸ºå­—ç¬¦ä¸²â€seq=41â€ã€‚
æ¥ç€æˆ‘ä»¬å¯ä»¥çœ‹åˆ°Looper.prepareMainLooper();è¯­å¥ï¼Œ</p>

<p>æˆ‘ä»¬çœ‹ä¸‹Looper.javaä¸­çš„prepareMainLooper()è¿™ä¸ªè¯­å¥ï¼Œé¦–å…ˆæ˜¯prepare(false),åœ¨è¿™é‡Œä¼šåˆ›å»ºä¸€ä¸ªLooperå¯¹è±¡æ”¾åœ¨sThreadLocalä¸­ã€‚</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="rouge-code"><pre><span class="cm">/**
 * Initialize the current thread as a looper, marking it as an
 * application's main looper. The main looper for your application
 * is created by the Android environment, so you should never need
 * to call this function yourself.  See also: {@link #prepare()}
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">prepareMainLooper</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">prepare</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="nc">Looper</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">sMainLooper</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"The main Looper has already been prepared."</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">sMainLooper</span> <span class="o">=</span> <span class="n">myLooper</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="o">...</span>
<span class="kd">private</span> <span class="nf">Looper</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">quitAllowed</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MessageQueue</span><span class="o">(</span><span class="n">quitAllowed</span><span class="o">);</span>
    <span class="n">mThread</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
<span class="o">}</span>
<span class="o">...</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">prepare</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">quitAllowed</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">sThreadLocal</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"Only one Looper may be created per thread"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">sThreadLocal</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="k">new</span> <span class="nc">Looper</span><span class="o">(</span><span class="n">quitAllowed</span><span class="o">));</span>
<span class="o">}</span>

<span class="o">...</span>
<span class="cm">/**
 * Return the Looper object associated with the current thread.  Returns
 * null if the calling thread is not associated with a Looper.
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="nd">@Nullable</span> <span class="nc">Looper</span> <span class="nf">myLooper</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">sThreadLocal</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
<span class="o">}</span>
<span class="o">...</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>ç„¶åsMainLooperä¼šå¾—åˆ°ä¸€ä¸ªLooperç±»å‹çš„å¯¹è±¡ï¼Œæˆ‘ä»¬å°±è®°ä½ï¼Œè¿™ä¸ªLooperæ˜¯å’Œå½“å‰çº¿ç¨‹ä¸€ä¸€å¯¹åº”çš„ã€‚</p>

<p>æˆ‘ä»¬å›åˆ°ActivityThreadçš„mainæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬çœ‹ä¸‹ActivityThread thread = new ActivityThread();è¿™ä¸ª
æ–°åˆ›å»ºäº†ä¸€ä¸ªActivityThreadå¯¹è±¡ï¼Œæˆ‘ä»¬è®°ä½ï¼Œä¸€ä¸ªåº”ç”¨åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­å°±åªåˆ›å»ºå’Œå…³è”ä¸€ä¸ªActivityThreadå¯¹è±¡ã€‚
æˆ‘ä»¬é‡ç‚¹å…³æ³¨ä¸‹thread.attach(false, startSeq);</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre></td><td class="rouge-code"><pre><span class="o">...</span>
<span class="nd">@UnsupportedAppUsage</span>
<span class="kd">final</span> <span class="nc">ApplicationThread</span> <span class="n">mAppThread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ApplicationThread</span><span class="o">();</span>
<span class="nd">@UnsupportedAppUsage</span>
<span class="kd">final</span> <span class="nc">Looper</span> <span class="n">mLooper</span> <span class="o">=</span> <span class="nc">Looper</span><span class="o">.</span><span class="na">myLooper</span><span class="o">();</span>
<span class="nd">@UnsupportedAppUsage</span>
<span class="kd">final</span> <span class="no">H</span> <span class="n">mH</span> <span class="o">=</span> <span class="k">new</span> <span class="no">H</span><span class="o">();</span>
<span class="o">...</span>

<span class="nd">@UnsupportedAppUsage</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">attach</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">system</span><span class="o">,</span> <span class="kt">long</span> <span class="n">startSeq</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">sCurrentActivityThread</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
    <span class="n">mSystemThread</span> <span class="o">=</span> <span class="n">system</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">system</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">android</span><span class="o">.</span><span class="na">ddm</span><span class="o">.</span><span class="na">DdmHandleAppName</span><span class="o">.</span><span class="na">setAppName</span><span class="o">(</span><span class="s">"&lt;pre-initialized&gt;"</span><span class="o">,</span>
                                                <span class="nc">UserHandle</span><span class="o">.</span><span class="na">myUserId</span><span class="o">());</span>
        <span class="nc">RuntimeInit</span><span class="o">.</span><span class="na">setApplicationObject</span><span class="o">(</span><span class="n">mAppThread</span><span class="o">.</span><span class="na">asBinder</span><span class="o">());</span>
        <span class="kd">final</span> <span class="nc">IActivityManager</span> <span class="n">mgr</span> <span class="o">=</span> <span class="nc">ActivityManager</span><span class="o">.</span><span class="na">getService</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">mgr</span><span class="o">.</span><span class="na">attachApplication</span><span class="o">(</span><span class="n">mAppThread</span><span class="o">,</span> <span class="n">startSeq</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RemoteException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">ex</span><span class="o">.</span><span class="na">rethrowFromSystemServer</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="c1">// Watch for getting close to heap limit.</span>
        <span class="nc">BinderInternal</span><span class="o">.</span><span class="na">addGcWatcher</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">mSomeActivitiesChanged</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="nc">Runtime</span> <span class="n">runtime</span> <span class="o">=</span> <span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">();</span>
                <span class="kt">long</span> <span class="n">dalvikMax</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">.</span><span class="na">maxMemory</span><span class="o">();</span>
                <span class="kt">long</span> <span class="n">dalvikUsed</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">.</span><span class="na">totalMemory</span><span class="o">()</span> <span class="o">-</span> <span class="n">runtime</span><span class="o">.</span><span class="na">freeMemory</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">dalvikUsed</span> <span class="o">&gt;</span> <span class="o">((</span><span class="mi">3</span><span class="o">*</span><span class="n">dalvikMax</span><span class="o">)/</span><span class="mi">4</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="no">DEBUG_MEMORY_TRIM</span><span class="o">)</span> <span class="nc">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Dalvik max="</span> <span class="o">+</span> <span class="o">(</span><span class="n">dalvikMax</span><span class="o">/</span><span class="mi">1024</span><span class="o">)</span>
                            <span class="o">+</span> <span class="s">" total="</span> <span class="o">+</span> <span class="o">(</span><span class="n">runtime</span><span class="o">.</span><span class="na">totalMemory</span><span class="o">()/</span><span class="mi">1024</span><span class="o">)</span>
                            <span class="o">+</span> <span class="s">" used="</span> <span class="o">+</span> <span class="o">(</span><span class="n">dalvikUsed</span><span class="o">/</span><span class="mi">1024</span><span class="o">));</span>
                    <span class="n">mSomeActivitiesChanged</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="nc">ActivityTaskManager</span><span class="o">.</span><span class="na">getService</span><span class="o">().</span><span class="na">releaseSomeActivities</span><span class="o">(</span><span class="n">mAppThread</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">throw</span> <span class="n">e</span><span class="o">.</span><span class="na">rethrowFromSystemServer</span><span class="o">();</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æˆ‘ä»¬çœ‹ä¸‹è¿™æ¡è¯­å¥ï¼Œmgr.attachApplication(mAppThread, startSeq);</p>

:ET