I"—+<h2 id="å¼•è¨€">å¼•è¨€</h2>
<p>åœ¨LLVM IRç®€ä»‹ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬æåˆ°LLVM IRæœ‰ä¸‰ç§å­˜åœ¨å½¢å¼ï¼Œåœ¨ç®€ä»‹ä¸€æ–‡ä¸­ä»‹ç»äº†å­˜åœ¨åœ¨æ–‡ä»¶ä¸­çš„
å¯è¯»IRå’ŒäºŒè¿›åˆ¶IRï¼Œæœ¬æ–‡å°†ç²—ç•¥ä»‹ç»ä¸‹IRåœ¨å†…å­˜ä¸­çš„å½¢æ€å¯¹åº”çš„æ•°æ®ç»“æ„ã€‚</p>

<h2 id="å¸¸è§ç±»çš„å±‚æ¬¡ç»“æ„class-hierarchy">å¸¸è§ç±»çš„å±‚æ¬¡ç»“æ„ï¼ˆClass Hierarchyï¼‰</h2>

<ol>
  <li>ValueåŠå¸¸è§å­ç±»</li>
</ol>

<p><img src="../assets/img/2019-10-08-llvm_ir_key_data_structure_introduction/1.png" alt="Value and Its Commonly-Used SubClasses" /></p>

<p>æˆ‘å¤§è‡´ç»˜åˆ¶äº†ä¸€äº›å¸¸è§çš„Valueçš„å­ç±»ï¼Œæ¯ä¸ªValueç±»å‹çš„å®ä¾‹éƒ½æ˜¯æœ‰Typeçš„ã€‚å…³äº<a href="http://llvm.org/docs/ProgrammersManual.html#the-value-class">Value</a>
å®˜æ–¹æ–‡æ¡£æœ‰è¿™æ ·ä¸€æ®µè¯ï¼š</p>
<blockquote>
  <p>The Value class is the most important class in the LLVM Source base. It represents a
typed value that may be used (among other things) as an operand to an instruction.</p>
</blockquote>

<p>åœ¨<a href="http://llvm.org/doxygen/Value_8h_source.html">Value</a>çš„doxygenä¸­ä¹Ÿæœ‰ä¸€æ®µæè¿°:</p>

<blockquote>
  <p>This is a very important LLVM class. It is the base class of all values computed by a
program that may be used as operands to other values. Value is the super class of
other important classes such as Instruction and Function. All Values have a Type. Type
is not a subclass of Value. Some values can have a name and they belong to some
Module. Setting the name on the Value automatically updates the moduleâ€™s symbol
table.</p>
</blockquote>

<p>ä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œåœ¨LLVMä¸­ï¼ŒBasicBlockã€Instructionã€Functionã€GlobalVariableç­‰æ¦‚å¿µï¼Œ
éƒ½å®ç°ä¸ºäº†Valueçš„å­ç±»ã€‚é™¤äº†BasicBlockå¤–ï¼Œå›¾ä¸­åˆ—ä¸¾çš„ç±»è¿˜æ˜¯Userç±»çš„å­ç±»ã€‚ä¸è¿‡è¯´å®Œè¿˜æ˜¯æ¯”
è¾ƒç©ºæ´ï¼Œè¿˜æ˜¯ç»“åˆä¸€ä¸ªä¾‹å­æ¥çœ‹ä¸‹æ¯”è¾ƒå¥½ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td> --><td class="rouge-code"><pre><span class="kt">int</span> <span class="nf">func</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="n">z</span><span class="p">){</span> 
  <span class="n">x</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">z</span><span class="p">;</span> 
  <span class="n">y</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">z</span><span class="p">;</span> 
  <span class="n">z</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">;</span> 
  <span class="k">return</span> <span class="n">z</span><span class="p">;</span> 
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>å°†è¯¥ä¾‹å­æ”¾ç½®åœ¨hello.cæ–‡ä»¶ä¸­ï¼Œå¹¶é€šè¿‡ä¸‹é¢ä¸¤ä¸ªå‘½ä»¤å°†å…¶è½¬æ¢æˆç»è¿‡mem2regä¼˜åŒ–çš„å¯è¯»IRæ–‡
ä»¶ã€‚è¿™ä¸¤ä¸ªå‘½ä»¤åœ¨ä¹‹å‰LLVM IRç®€ä»‹ä¸€æ–‡ä¸­æœ‰è¿‡è§£é‡Šï¼Œè¿™é‡Œå†æ¬¡ç²˜è´´ä¸€ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td> --><td class="rouge-code"><pre>clang hello.c -emit-llvm -S -Xclang -disable-O0-optnone 
opt -mem2reg -S hello.ll &gt; hello.m2r.ll
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è½¬æ¢çš„IRæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td> --><td class="rouge-code"><pre><span class="n">define</span> <span class="n">dso_local</span> <span class="n">i32</span> <span class="err">@</span><span class="n">func</span><span class="p">(</span><span class="n">i32</span> <span class="o">%</span><span class="mi">0</span><span class="p">,</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">1</span><span class="p">,</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">2</span><span class="p">)</span> <span class="err">#</span><span class="mi">0</span> <span class="p">{</span> 
  <span class="o">%</span><span class="mi">4</span> <span class="o">=</span> <span class="n">add</span> <span class="n">nsw</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">1</span><span class="p">,</span> <span class="o">%</span><span class="mi">2</span> 
  <span class="o">%</span><span class="mi">5</span> <span class="o">=</span> <span class="n">add</span> <span class="n">nsw</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">4</span><span class="p">,</span> <span class="o">%</span><span class="mi">2</span> 
  <span class="o">%</span><span class="mi">6</span> <span class="o">=</span> <span class="n">add</span> <span class="n">nsw</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">4</span><span class="p">,</span> <span class="o">%</span><span class="mi">5</span> 
  <span class="n">ret</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">6</span> 
<span class="p">}</span> 
</pre></td></tr></tbody></table></code></pre></div></div>
<p>ä¸ºäº†è¯´æ˜é—®é¢˜ï¼Œå°†å…¶è½¬åŒ–æˆä¸‹å›¾ï¼š</p>

<p><img src="../assets/img/2019-10-08-llvm_ir_key_data_structure_introduction/2.png" alt="IR Illustration" /></p>

<p>è¿™é‡Œï¼Œç€é‡çœ‹è™šçº¿æ¡†æ¡†å‡ºæ¥çš„ä¸‰æ¡æŒ‡ä»¤ï¼Œæ¯æ¡æŒ‡ä»¤åœ¨å†…å­˜ä¸­éƒ½ç”±ä¸€ä¸ªInstructionå­ç±»å¯¹è±¡æ¥è¡¨
ç¤ºï¼Œç”±äºInstructionæ˜¯Valueçš„å­ç±»ï¼Œæ‰€ä»¥ä¸Šé¢ä¸‰æ¡Instructionå¯ä»¥çœ‹åšæ˜¯ä¸‰ä¸ªValueï¼Œç”±äºè¿™ä¸ª
IRæ˜¯SSAæ ¼å¼çš„ï¼Œæ‰€ä»¥æ¯ä¸ªè™šæ‹Ÿå¯„å­˜å™¨éƒ½ç”±å”¯ä¸€ä¸€æ¡Instructionèµ‹å€¼ï¼Œæ‰€ä»¥ï¼Œè™šæ‹Ÿå¯„å­˜
å™¨%4,%5,%6ä¹Ÿéƒ½èƒ½å”¯ä¸€ä»£è¡¨å¯¹åº”çš„Instructionã€‚</p>

<p>Instructionä¹Ÿæ˜¯Userçš„å­ç±»ï¼ŒInstructionä¼šä½¿ç”¨å…¶ä»–çš„Valueæ¥ä½œä¸ºè‡ªå·±çš„ç»„æˆéƒ¨åˆ†ï¼Œæ¯”å¦‚ï¼Œå¯¹äº
çº¢è‰²æ¡†ä¸­%6å¯„å­˜å™¨å¯¹åº”çš„æŒ‡ä»¤æ¥è¯´ï¼Œå®ƒæœ‰ä¸¤ä¸ªæ“ä½œæ•°ï¼ˆoperandï¼‰ï¼Œå¯¹åº”ä¸¤ä¸ªValueï¼Œä¸€ä¸ªæ˜¯%4
å¯¹åº”çš„Instructionï¼Œä¸€ä¸ªæ˜¯%5å¯¹åº”çš„Instructionï¼Œå¦‚ä¸Šå›¾ç´«è‰²ç®­å¤´æŒ‡å‘ã€‚</p>

<p>æŸ¥çœ‹æ¶‰åŠ<a href="http://llvm.org/docs/ProgrammersManual.html#the-value-class">Value</a>çš„ç¼–ç¨‹æ–‡æ¡£ï¼Œæœ‰è¿™æ ·ä¸€æ®µè¯ï¼š</p>

<blockquote>
  <p>A particular Value may be used many times in the LLVM representation for a program.
To keep track of this relationship, the Value class keeps a list of all of the User s that is
using it.</p>
</blockquote>

<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸ªValueå¯ä»¥è¢«ä½¿ç”¨è®¸å¤šæ¬¡ï¼Œä¸ºäº†è·Ÿè¸ªå“ªäº›Userä½¿ç”¨äº†è‡ªå·±ï¼Œæ¯ä¸ªValueåœ¨å…¶å¯¹è±¡å†…
éƒ¨éƒ½ç»´æŒäº†ä¸€ä¸ªUseré“¾è¡¨ã€‚ä»¥ä¸Šé¢çš„ä¾‹å­æ¥è¯´ï¼Œå¯¹äºé»„è‰²è™šçº¿æ¡†ä¸­çš„æŒ‡ä»¤æ¥è¯´ï¼Œå…¶Useré“¾è¡¨ä¸­åŒ…
å«äº†è“è‰²æ¡†å’Œçº¢è‰²æ¡†æŒ‡ä»¤ï¼Œå› ä¸ºè“è‰²æ¡†æŒ‡ä»¤å’Œçº¢è‰²æ¡†æŒ‡ä»¤éƒ½ä½¿ç”¨äº†é»„è‰²æ¡†æŒ‡ä»¤ï¼Œå³ï¼Œéƒ½ä½¿ç”¨äº†%4
å¯„å­˜å™¨ã€‚</p>

<p>æŸ¥çœ‹<a href="http://llvm.org/doxygen/Value_8h_source.html">Value.h</a>ï¼Œæœ‰è¿™æ ·ä¸€æ®µè¯ï¼š</p>

<blockquote>
  <p>Every value has a â€œuse listâ€ that keeps track of which other Values are using this Value.</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td> --><td class="rouge-code"><pre>class Value { 
   Type *VTy; // indicates what type the current instance is 
   Use *UseList; 
   ... 
}
</pre></td></tr></tbody></table></code></pre></div></div>

<p>çœ‹ä¸€ä¸‹<a href="http://llvm.org/doxygen/Use_8h_source.html#l00055">Use.h</a>ä¸­å…³äºUseçš„å®šä¹‰</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td> --><td class="rouge-code"><pre>// A Use represents the edge between a Value definition and its users. 
class Use { 
   ... 
   Value *Val; // refer to one User instance that uses current Value instance 
   Use *Next; 
   ... 
} 
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ‰€ä»¥åœ¨å†…å­˜ä¸­ï¼Œuse listç±»ä¼¼äºè¿™ç§ï¼š</p>

<p><img src="../assets/img/2019-10-08-llvm_ir_key_data_structure_introduction/user_list.png" alt="User List" /></p>

<p>æ¥ä¸‹æ¥å…³æ³¨ä¸‹Functionå’ŒGlobalVariableç±»ï¼ŒæŠŠä¸Šå›¾åœ¨ä¸‹é¢å†ç²˜è´´ä¸€ä¸‹</p>

<p><img src="../assets/img/2019-10-08-llvm_ir_key_data_structure_introduction/1.png" alt="Value and Its Commonly-Used SubClasses" /></p>

<p>ä¸ºå•¥å…¨å±€å˜é‡ï¼ˆGlobalVariableï¼‰å’Œå‡½æ•°ï¼ˆFunctionï¼‰æ˜¯ç”¨Constantçš„å­ç±»ï¼Œå¯èƒ½å¯ä»¥è¿™æ ·ç†
è§£ï¼Œé‚£å°±æ˜¯å…¨å±€å˜é‡å’Œå‡½æ•°å®ƒä»¬åœ¨é“¾æ¥åï¼Œå®ƒä»¬çš„Valueï¼ˆå³åœ°å€addressï¼‰éƒ½æ˜¯å›ºå®šçš„ï¼Œä»è¿™ç§
è§’åº¦æ¥è¯´ï¼Œæ˜¯å¸¸é‡ã€‚</p>

<p>å¦å¤–ï¼Œç”±äºå…¨å±€å˜é‡å’Œå‡½æ•°èƒ½å¤Ÿåœ¨ä¸åŒå‡½æ•°é—´è¢«è®¿é—®åˆ°ï¼Œæ‰€ä»¥å®ƒä»¬æ˜¯GlobalValueçš„å­ç±»ä¹Ÿæ˜¯æ¯”è¾ƒ
å¥½ç†è§£çš„ã€‚</p>

<ol>
  <li>TypeåŠå¸¸è§å­ç±»</li>
</ol>

<p><img src="../assets/img/2019-10-08-llvm_ir_key_data_structure_introduction/type_and_subclass.png" alt="User List" /></p>

<p>æ¯ä¸ªValueéƒ½æœ‰ä¸€ä¸ªTypeï¼Œè¿™ä¸ªå¾ˆå¥½ç†è§£å“ˆï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒTypeä¸æ˜¯Valueçš„å­ç±»å“ˆã€‚
ç¨å¾®æä¸€ä¸‹<a href="http://llvm.org/docs/ProgrammersManual.html#functiontype">FunctionType</a>ï¼Œå®ƒä¸ºFunctionæŒ‡å®šäº†å½¢å¼åŒ–å‚æ•°å’Œè¿”å›å€¼ä¿¡æ¯ã€‚ä¸€ä¸ªFunctionTypeå®
ä¾‹å¯ä»¥è¢«å¤šä¸ªFunctionå®ä¾‹å…±ç”¨ï¼Œå½“è¿™äº›Functionå…·æœ‰ç›¸åŒçš„å‚æ•°ç±»å‹å’Œè¿”å›ç±»å‹ã€‚</p>

<h2 id="modulefunctionbasicblockä»¥åŠinstructionåœ¨å†…å­˜ä¸­çš„ç»„ç»‡å…³ç³»">Moduleã€Functionã€BasicBlockä»¥åŠInstructionåœ¨å†…å­˜ä¸­çš„ç»„ç»‡å…³ç³»</h2>

<p>å…¶æ¬¡ä»‹ç»ä¸€ä¸‹Moduleã€Functionã€BasicBlockä»¥åŠInstructionå®ä¾‹ä¹‹é—´åœ¨å†…å­˜ä¸­çš„ç»„ç»‡å…³ç³»</p>

<p><img src="../assets/img/2019-10-08-llvm_ir_key_data_structure_introduction/relation.png" alt="Organization In Memory" /></p>

<p>ä¸Šå›¾éå¸¸æ¸…æ™°çš„å°†è¿™å››ä¸ªç»“æ„åœ¨LLVMä¸­çš„ç»„ç»‡æ–¹å¼å±•ç¤ºäº†å‡ºæ¥ï¼Œå¯ä»¥çœ‹å‡ºï¼Œè¿™äº›æ•°æ®ç»“æ„ä»¥æŸç§
é“¾è¡¨çš„å½¢å¼è¿›è¡Œäº†è¿æ¥ï¼ŒLLVMä¸­æä¾›äº†iteratorä»¥åŠvisitorç­‰ä¸¤ç§æ–¹å¼æ¥éå†è¿™äº›ç»“æ„ï¼Œåœ¨éå†çš„
è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥é€šè¿‡ä»£ç æ¥å¯¹è¿™äº›ç»“æ„è¿›è¡Œå¢åˆ æ”¹æŸ¥ç­‰ä¸€ç³»åˆ—æ“ä½œï¼Œä¸‹ä¸€ç¯‡æ–‡ç« å°†ä¾æ®æœ¬ç« çš„çŸ¥è¯†ï¼Œ
é€šè¿‡ä¸€äº›ä»£ç æ¥æ¼”ç¤ºå¦‚ä½•æ“ä½œLLVM IRã€‚
å…¶ä»–æœªè§å†…å®¹å¯ä»¥å‚è€ƒèµ„æ–™<a href="#refer-anchor-1"><sup>1</sup></a><a href="#refer-anchor-2"><sup>2</sup></a><a href="#refer-anchor-3"><sup>3</sup></a></p>

<h2 id="references">References</h2>

<div id="refer-anchor-1"></div>
<p>[1]. <a href="http://llvm.org/docs/ProgrammersManual.html">LLVMç¼–ç¨‹æ‰‹å†Œ</a></p>
<div id="refer-anchor-2"></div>
<p>[2]. <a href="http://llvm.org/docs/WritingAnLLVMPass.html">LLVM Pass ç¼–å†™æŒ‡å—</a></p>
<div id="refer-anchor-3"></div>
<p>[3]. <a href="https://llvm.org/doxygen">LLVM APIæ–‡æ¡£</a></p>
:ET